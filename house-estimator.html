<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <!-- âœ… è‡ªå‹•èª¿ç¯€ç¸®æ”¾ã€iOS ç€æµ·å®‰å…¨å€ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ğŸ  æˆ¿ç”¢è²»ç”¨æ™ºæ…§ä¼°ç®—ä¸­å¿ƒï¼ˆç„¡åœ–è¡¨ç‰ˆï¼‰</title>

  <!-- åœ–ç¤ºå­—å‹ï¼šBootstrap Icons + Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    /* ----------------------------------------------------------
       Bootswatch-likeï¼ˆå­é›†ï¼‰ä¸»é¡Œ + RWD/ç©©å®šæ»‘å‹•/ä¸æ›è¡Œå„ªåŒ–
       ---------------------------------------------------------- */
    :root{
      --base-fz: clamp(14px, 1.6vw, 17px);
      --brand-1:#0abf9e;   /* ç¶ æ¾çŸ³ */
      --brand-2:#ffb703;   /* æš–é»ƒ */
      --brand-3:#f17b5f;   /* æ©˜ç´… */
      --brand-4:#36a2eb;   /* è— */
      --bg-1:#fdfcf8;
      --text-1:#24323f;
      --muted:#6b7a86;
      --card:#ffffff;
      --ring:#9debdc;
      --container-max: 1200px;
    }

    html{
      font-size: var(--base-fz);
      -webkit-text-size-adjust: 100%;
    }
    body{
      font-family: "Microsoft JhengHei","Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"PingFang TC","Heiti TC","å„·é»‘ Pro",sans-serif;
      color: var(--text-1);
      background: radial-gradient(1200px 800px at 10% -10%, #e7fff7 0%, transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, #fff6d8 0%, transparent 60%),
                  var(--bg-1);
      line-height: 1.5;
      /* âœ… å›ºå®šæ¡†æ¶ï¼‹ç©©å®šæ»‘å‹• */
      overflow-y: scroll;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* âœ… ç›’æ¨¡å‹ï¼è¼¸å…¥å…ƒä»¶ä¸è¶…å‡ºå®¹å™¨ï¼ˆè¦ç¯„å¿…è¦ï¼‰ */
    * { box-sizing: border-box; }
    input, select, textarea { max-width: 100%; font-size: 16px; } /* 16px é˜² iOS èšç„¦æ”¾å¤§ */

    .container{ max-width: var(--container-max); margin: 0 auto; padding: 20px clamp(12px, 4vw, 24px); }

    .page-title{ text-align:center; margin-bottom: 18px; }
    .page-title h1{
      font-size: clamp(22px, 4.2vw, 40px);
      margin: 8px 0 6px; font-weight: 800;
      display:flex; align-items:center; justify-content:center; gap:12px;
      letter-spacing: .5px;
    }
    .page-title p{ color: var(--muted); font-size: clamp(13px, 1.8vw, 16px); }

    .switcher{
      display:flex; gap: 8px; justify-content:center; margin: 12px 0 22px;
      background: #fff; padding: 8px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.06);
    }
    .btn{
      border: none; padding: clamp(10px, 2.2vw, 12px) clamp(14px, 3vw, 18px); border-radius: 10px; cursor: pointer; font-weight: 700;
      transition: .2s ease; display: inline-flex; align-items:center; gap: 8px;
    }
    .btn:focus{ outline: 3px solid var(--ring); outline-offset: 2px; }
    .btn-ghost{ background: transparent; color: var(--muted); }
    .btn-ghost:hover{ background: #f2f4f6; color: var(--text-1); }
    .btn-green{ background: var(--brand-1); color: #fff; }
    .btn-green:hover{ filter: brightness(.95); transform: translateY(-1px); }
    .btn-gray{ background: #768a9a; color: #fff; }
    .btn-gray:hover{ filter: brightness(.95); }

    .grid{ display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 992px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: var(--card); border-radius: 16px; padding: clamp(16px, 3.4vw, 20px);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .card h2{ font-size: clamp(18px, 2.6vw, 22px); font-weight: 800; margin: 0 0 6px; display:flex; align-items:center; gap:10px; }
    .subtle{ color: var(--muted); margin-bottom: 12px; font-size: clamp(13px,1.8vw,15px); }

    /* è¡¨å–® */
    .form-row{ display: grid; gap: 12px; grid-template-columns: 1fr; margin-bottom: 12px; }
    @media (min-width: 600px){ .form-row.cols-2{ grid-template-columns: 1fr 1fr; } }
    .form-group label{ display:block; font-size: 14px; color: #415363; margin-bottom: 6px; font-weight: 600; }
    .input, .select{
      width: 100%; padding: 12px 14px; border: 1px solid #d8e2ea; border-radius: 10px;
      outline: none; transition: .15s border, .15s box-shadow; background: #fff;
    }
    .input:focus, .select:focus{ border-color: var(--brand-1); box-shadow: 0 0 0 4px #d6faf1; }

    .section-toggle{
      width: 100%; border-radius: 10px; padding: 10px 14px; text-align: left;
      background: #fff6d8; color: #7a4c00; border: 1px solid #ffe6a7;
      font-weight: 700;
    }
    .toggle-panel{ margin-top: 12px; background:#f6fafb; border:1px dashed #d1e8ef; padding:14px; border-radius:12px; }

    /* çµæœé‡é»æ•¸å­—ï¼ˆç½®ä¸­ã€è¶…å¤§ã€ç²—é«”ï¼‹ä¸åŒè‰²ï¼‰ */
    .hero-number{ font-size: clamp(26px, 6.2vw, 48px); font-weight: 900; color: var(--brand-1); text-shadow: 0 2px 0 rgba(0,0,0,.05); }
    .hero-number.blue{ color: var(--brand-4); }
    .hero-note{ color: #3b4a57; opacity: .9; font-size: clamp(13px,1.8vw,15px); }
    .badge{
      display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700;
      background: #e8fff9; color:#0f6b5b; border:1px solid #b9f5e9;
    }

    .kpi-grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 700px){ .kpi-grid{ grid-template-columns: 1fr 1fr; } }
    .kpi{ background:#f8fbfd; border:1px solid #e5eef5; border-radius: 12px; padding: 12px; }
    .kpi .label{ color:#6c7c89; font-size: 13px; }
    .kpi .value{ font-weight: 800; font-size: clamp(16px, 2vw, 20px); }

    /* CTAï¼šå®˜æ–¹å¸³è™Ÿä¸€è¡Œé¡¯ç¤ºã€ä¸æ›è¡Œã€å¯æ°´å¹³æ»‘å‹• */
    .cta{ margin-top:16px; text-align:center; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .cta a{
      display:inline-flex; align-items:center; gap:10px; padding: 14px 18px;
      background: var(--brand-1); color:#fff; border-radius:12px; font-weight:800;
      box-shadow: 0 10px 24px rgba(10,191,158,.25);
      transition: .2s; transform: translateZ(0);
      white-space: nowrap; width: max-content;
      font-size: clamp(12px, 1.8vw, 16px); text-decoration: none;
    }
    .cta a:hover{ filter: brightness(.95); transform: translateY(-1px); }

    /* æº«é¦¨æé†’ */
    .note{ background:#fff8e8; border:1px solid #ffe3a9; border-radius:14px; padding:16px; margin-top:20px; }
    .note h3{ margin:0 0 8px; }
    .note ul{ margin:0; padding-left: 1em; color:#7a5b00; }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- æ¨™é¡Œå€ -->
    <div class="page-title">
      <h1><i class="bi bi-house-heart-fill" style="color:#ff7b54"></i> æˆ¿ç”¢è²»ç”¨æ™ºæ…§ä¼°ç®—ä¸­å¿ƒ</h1>
      <p>è²·æ–¹è³£æ–¹ä¸€ç«™å¼æœå‹™ï¼Œç²¾æº–è¨ˆç®—æ‚¨çš„æˆ¿ç”¢è²¡å‹™è¦åŠƒ</p>
    </div>

    <!-- æ¨¡å¼åˆ‡æ› -->
    <div class="switcher" role="tablist" aria-label="æ¨¡å¼åˆ‡æ›">
      <button id="btnBuyer" class="btn btn-green" aria-selected="true">
        <i class="bi bi-calculator"></i> æˆ‘æ˜¯è²·æ–¹
      </button>
      <button id="btnSeller" class="btn btn-ghost" aria-selected="false">
        <i class="bi bi-graph-up-arrow"></i> æˆ‘æ˜¯è³£æ–¹
      </button>
    </div>

    <div class="grid">
      <!-- è¼¸å…¥å¡ç‰‡ -->
      <section class="card" id="cardInputs" aria-labelledby="formTitle">
        <h2 id="formTitle"><i class="bi bi-calculator-fill" style="color:var(--brand-1)"></i> <span id="formTitleText">è²·æ–¹è²»ç”¨ä¼°ç®—</span></h2>
        <p class="subtle" id="formSubtitle">è¨ˆç®—è³¼å±‹æ‰€éœ€çš„ç¸½è‡ªå‚™æ¬¾èˆ‡ç›¸é—œè²»ç”¨</p>

        <!-- è²·æ–¹è¡¨å–® -->
        <form id="formBuyer">
          <div class="form-row">
            <div class="form-group">
              <label>æˆ¿å±‹ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰</label>
              <input id="bHousePrice" type="number" class="input" placeholder="è«‹è¼¸å…¥æˆ¿å±‹ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>è²¸æ¬¾æˆæ•¸</label>
              <div>
                <label><input type="radio" name="bLoanRatio" value="75"> 75æˆ</label>&nbsp;&nbsp;
                <label><input type="radio" name="bLoanRatio" value="80" checked> 80æˆ</label>&nbsp;&nbsp;
                <label><input type="radio" name="bLoanRatio" value="85"> 85æˆ</label>
              </div>
            </div>
          </div>

          <div class="form-row cols-2">
            <div class="form-group">
              <label>è²¸æ¬¾å¹´æœŸ</label>
              <select id="bLoanYears" class="select">
                <option value="20">20å¹´</option>
                <option value="30" selected>30å¹´</option>
                <option value="40">40å¹´</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰</label>
              <input id="bInterest" type="number" step="0.1" class="input" value="2.1">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>å¯¬é™æœŸï¼ˆå¹´ï¼‰</label>
              <input id="bGraceYears" type="number" class="input" placeholder="å¯ç•™ç™½">
            </div>
          </div>

          <!-- é›œè²»ï¼ˆå¯é¸ï¼‰ -->
          <button class="section-toggle" type="button" data-target="#buyerMisc">é›œé …è²»ç”¨ï¼ˆå¯é¸å¡«ï¼‰</button>
          <div id="buyerMisc" class="toggle-panel hidden">
            <div class="form-row cols-2">
              <div class="form-group"><label>æœå‹™è²»ï¼ˆNT$ï¼‰</label><input id="bServiceFee" type="number" class="input"></div>
              <div class="form-group"><label>ä»£æ›¸è²»ï¼ˆNT$ï¼‰</label><input id="bNotaryFee" type="number" class="input"></div>
              <div class="form-group"><label>ä»²ä»‹è²»ï¼ˆNT$ï¼‰</label><input id="bAgentFee" type="number" class="input"></div>
              <div class="form-group"><label>å¥‘ç¨…ï¼ˆNT$ï¼‰</label><input id="bContractTax" type="number" class="input"></div>
              <div class="form-group"><label>åœ°æ”¿è¦è²»ï¼ˆNT$ï¼‰</label><input id="bRegFee" type="number" class="input"></div>
              <div class="form-group"><label>ç«éšª/åœ°éœ‡éšªï¼ˆNT$ï¼‰</label><input id="bInsurance" type="number" class="input"></div>
            </div>
          </div>
        </form>

        <!-- è³£æ–¹è¡¨å–® -->
        <form id="formSeller" class="hidden">
          <div class="form-row">
            <div class="form-group">
              <label>æˆ¿å±‹æˆäº¤ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰</label>
              <input id="sSalePrice" type="number" class="input" placeholder="è«‹è¼¸å…¥æˆäº¤ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>ç•¶åˆè³¼è²·ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰</label>
              <input id="sPurchasePrice" type="number" class="input" placeholder="è«‹è¼¸å…¥è³¼è²·ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰">
            </div>
          </div>

          <div class="form-row cols-2">
            <div class="form-group">
              <label>å–å¾—æ—¥æœŸ</label>
              <input id="sPurchaseDate" type="date" class="input">
            </div>
            <div class="form-group">
              <label>è½‰ç§»æ—¥æœŸ</label>
              <input id="sSaleDate" type="date" class="input">
            </div>
          </div>

          <!-- è‡ªä½å„ªæƒ æ¢ä»¶ -->
          <div class="toggle-panel" style="background:#eef8ff; border-color:#cfe7ff">
            <strong class="badge"><i class="fa-solid fa-house-chimney"></i> è‡ªä½å„ªæƒ æ¢ä»¶</strong>
            <div class="form-row">
              <label><input id="sOwner" type="checkbox"> ç‚ºæœ¬äººï¼é…å¶ï¼æœªæˆå¹´å­å¥³è‡ªä½</label>
              <label><input id="sResidence" type="checkbox"> è¨­ç±ä¸”é€£çºŒæŒæœ‰æ»¿ 6 å¹´</label>
              <label><input id="sRented" type="checkbox"> äº¤æ˜“å‰ 6 å¹´å…§æ›¾å‡ºç§Ÿæˆ–åšç‡Ÿæ¥­ä½¿ç”¨ï¼ˆè‹¥æœ‰è«‹æ‰“å‹¾ï¼‰</label>
            </div>
          </div>

          <div class="form-row cols-2">
            <div class="form-group">
              <label>æ”¹è‰¯è²»ç”¨ï¼ˆNT$ï¼‰</label>
              <input id="sImprove" type="number" class="input" placeholder="è£ä¿®ç­‰è²»ç”¨">
            </div>
            <div class="form-group">
              <label>åœŸåœ°æ¼²åƒ¹ç¸½æ•¸é¡ï¼ˆNT$ï¼‰</label>
              <input id="sLVI" type="number" class="input" placeholder="ç”±æ©Ÿé—œæä¾›">
            </div>
          </div>

          <!-- é›œè²»ï¼ˆå¯é¸ï¼‰ -->
          <button class="section-toggle" type="button" data-target="#sellerMisc">é›œé …è²»ç”¨ï¼ˆå¯é¸å¡«ï¼‰</button>
          <div id="sellerMisc" class="toggle-panel hidden">
            <div class="form-row cols-2">
              <div class="form-group"><label>ä»²ä»‹æœå‹™è²»ç‡ï¼ˆ%ï¼‰</label><input id="sAgentRate" type="number" step="0.1" class="input" value="2"></div>
              <div class="form-group"><label>ä»£æ›¸è²»ï¼ˆNT$ï¼‰</label><input id="sNotary" type="number" class="input" value="15000"></div>
              <div class="form-group"><label>å¥‘ç¨…ï¼ˆNT$ï¼‰</label><input id="sContract" type="number" class="input"></div>
              <div class="form-group"><label>å°èŠ±ç¨…ï¼ˆNT$ï¼‰</label><input id="sStamp" type="number" class="input"></div>
              <div class="form-group"><label>å…¬è­‰è²»ï¼ˆNT$ï¼‰</label><input id="sCert" type="number" class="input"></div>
              <div class="form-group"><label>æˆ¿è²¸æ¸…å„Ÿé¤˜é¡ï¼ˆNT$ï¼‰</label><input id="sPayoff" type="number" class="input"></div>
              <div class="form-group"><label>å…¶ä»–è²»ç”¨ï¼ˆNT$ï¼‰</label><input id="sOther" type="number" class="input"></div>
            </div>
          </div>
        </form>

        <!-- å‹•ä½œæŒ‰éˆ• -->
        <div style="display:flex; gap:10px; margin-top: 12px;">
          <button id="btnCalc" class="btn btn-green" style="flex:1"><i class="bi bi-play-fill"></i> é–‹å§‹ä¼°ç®—</button>
          <button id="btnClear" class="btn btn-gray" style="flex:1"><i class="bi bi-arrow-counterclockwise"></i> æ¸…é™¤é‡å¡«</button>
        </div>
      </section>

      <!-- çµæœå¡ç‰‡ï¼ˆç§»é™¤åœ–è¡¨ï¼Œæ”¹ä»¥é‡é»æ•¸å­—ï¼‹å¡ç‰‡åˆ—å‡ºï¼‰ -->
      <section class="card" id="cardResults">
        <h2><i class="bi bi-stars" style="color:var(--brand-2)"></i> æ‚¨çš„ä¼°ç®—çµæœ</h2>
        <div id="placeholder" class="subtle" style="text-align:center; padding: 26px 6px;">
          <i class="bi bi-calculator" style="font-size:56px; opacity:.35;"></i>
          <p>è«‹å¡«å¯«å·¦å´è³‡è¨Šä¸¦é»æ“Šã€Œé–‹å§‹ä¼°ç®—ã€</p>
        </div>

        <!-- è²·æ–¹çµæœï¼ˆç„¡é•·æ¢åœ–ï¼‰ -->
        <div id="buyerResults" class="hidden">
          <div class="kpi" style="text-align:center; background: linear-gradient(180deg,#e8fff9,#ffffff 60%); border-color:#c8f3e9;">
            <div class="label">ç¸½è‡ªå‚™æ¬¾</div>
            <div class="hero-number">NT$ <span id="bHeroDown">-</span> å…ƒ</div>
            <div class="hero-note">è²¸æ¬¾é‡‘é¡ï¼šNT$ <strong id="bHeroLoan">-</strong> å…ƒ</div>
          </div>

          <!-- ä»¥å¡ç‰‡æ¸…æ¥šå‘ˆç¾ä¸‰ç¨®æˆæ•¸ -->
          <div class="kpi-grid" id="bDetailGrid"></div>
        </div>

        <!-- è³£æ–¹çµæœï¼ˆç§»é™¤åœ“é¤…åœ–ï¼‰ -->
        <div id="sellerResults" class="hidden">
          <div class="kpi" style="text-align:center; background: linear-gradient(180deg,#eef6ff,#ffffff 60%); border-color:#d7e7ff;">
            <div class="label">è³‡é‡‘å–å›ç¸½é¡</div>
            <div class="hero-number blue">NT$ <span id="sHeroNet">-</span> å…ƒ</div>
            <div class="hero-note">
              æŒæœ‰æœŸé–“ï¼š<span id="sYears">-</span> å¹´ |
              é©ç”¨ç¨…ç‡ï¼š<span id="sRate">-</span>
              <div id="sBadge" class="badge hidden" style="margin-top:6px;">âœ“ ç¬¦åˆè‡ªä½å„ªæƒ æ¢ä»¶</div>
              <div id="sExempt" class="hidden" style="color:#0d7c68; font-weight:700; margin-top:6px;">å…ç¨…é¡åº¦ï¼šNT$ <span id="sExemptAmt"></span> å…ƒ</div>
            </div>
          </div>

          <!-- ç”¨å››æ ¼ KPI å¡ç‰‡å‘ˆç¾é—œéµè²»ç”¨ -->
          <div class="kpi-grid">
            <div class="kpi"><div class="label">æˆäº¤ç¸½åƒ¹</div><div class="value" id="sSale">-</div></div>
            <div class="kpi"><div class="label">å‡ºå”®ç²åˆ©ï¼ˆèª²ç¨…æ‰€å¾—ï¼‰</div><div class="value" id="sTaxable">-</div></div>
            <div class="kpi"><div class="label">æˆ¿åœ°åˆä¸€ç¨…</div><div class="value" id="sCGT">-</div></div>
            <div class="kpi"><div class="label">ä»²ä»‹è²»</div><div class="value" id="sAgent">-</div></div>
          </div>
        </div>
      </section>
    </div>

    <!-- CTAï¼šå®˜æ–¹å¸³è™Ÿå›ºå®šå–®è¡Œ -->
    <div class="cta" aria-label="åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿï¼ˆå¯æ°´å¹³æ»‘å‹•ï¼‰">
      <a href="https://lin.ee/9GV0YQ1D" target="_blank" rel="noopener">
        <i class="fa-brands fa-line"></i>
        <span>ä½å•†æ¥Šæ¢…å¤§é †åº— - å­è²ã€æ¿¬ç‘’å®˜æ–¹å¸³è™Ÿ</span>
      </a>
      <div class="subtle" style="margin-top:6px;">å°ˆæ¥­æˆ¿å±‹è²¸æ¬¾è«®è©¢æœå‹™ï¼Œæ­¡è¿åŠ å…¥ LINE æ´½è©¢</div>
    </div>

    <!-- æº«é¦¨æé†’ -->
    <div class="note">
      <h3><i class="bi bi-lightbulb-fill" style="color:#e6a200"></i> æº«é¦¨æé†’</h3>
      <ul>
        <li>ä»¥ä¸Šç‚ºè©¦ç®—çµæœï¼Œå¯¦éš›è²¸æ¬¾æ¢ä»¶èˆ‡åˆ©ç‡ä»é ˆä»¥å„å®¶éŠ€è¡Œå¯©æ ¸ç‚ºæº–ã€‚</li>
        <li>æˆ¿å±‹ç¨…ã€åœ°åƒ¹ç¨…ã€ç®¡ç†è²»ç­‰æŒæœ‰æˆæœ¬æœªåˆ—å…¥è¨ˆç®—ï¼Œè«‹ä¸€ä½µè€ƒé‡ã€‚</li>
        <li>æˆ¿åœ°åˆä¸€ç¨…è¨ˆç®—åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç¨…é¡è«‹æ´½è©¢ç¨…å‹™å°ˆæ¥­äººå£«ã€‚</li>
      </ul>
    </div>
  </div>

  <script>
    /* ==========================================================
       ğŸ§  è¨ˆç®—é‚è¼¯ï¼ˆç§»é™¤æ‰€æœ‰ Chart.jsã€canvasï¼‰
       - ä¿ç•™ï¼šä¸‰ç¨®è²¸æ¬¾æˆæ•¸çš„æ˜ç´°å¡ç‰‡
       ========================================================== */
    const nf = new Intl.NumberFormat('zh-TW');
    const fmt = n => nf.format(Math.round(n ?? 0));
    let mode = 'buyer';
    const $ = s => document.querySelector(s);

    // æŠ˜ç–Šé¢æ¿ï¼šé›œé …è²»ç”¨
    document.querySelectorAll('.section-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-target');
        document.querySelector(target).classList.toggle('hidden');
      });
    });

    // æ¨¡å¼åˆ‡æ›ï¼ˆè²·ï¼è³£ï¼‰
    $('#btnBuyer').addEventListener('click', ()=>{
      mode='buyer';
      $('#btnBuyer').className='btn btn-green';
      $('#btnSeller').className='btn btn-ghost';
      $('#formBuyer').classList.remove('hidden');
      $('#formSeller').classList.add('hidden');
      $('#formTitleText').textContent='è²·æ–¹è²»ç”¨ä¼°ç®—';
      $('#formSubtitle').textContent='è¨ˆç®—è³¼å±‹æ‰€éœ€çš„ç¸½è‡ªå‚™æ¬¾èˆ‡ç›¸é—œè²»ç”¨';
      resetResults();
    });
    $('#btnSeller').addEventListener('click', ()=>{
      mode='seller';
      $('#btnBuyer').className='btn btn-ghost';
      $('#btnSeller').className='btn btn-green';
      $('#formBuyer').classList.add('hidden');
      $('#formSeller').classList.remove('hidden');
      $('#formTitleText').textContent='è³£æ–¹è²»ç”¨ä¼°ç®—';
      $('#formSubtitle').textContent='è¨ˆç®—å”®å±‹æ‰€éœ€çš„ç¸½æ”¯å‡ºèˆ‡ç›¸é—œè²»ç”¨';
      resetResults();
    });

    // æ¸…é™¤é‡å¡«
    $('#btnClear').addEventListener('click', ()=>{
      if(mode==='buyer'){
        $('#formBuyer').reset();
        $('#bInterest').value = 2.1;
        document.querySelector('input[name="bLoanRatio"][value="80"]').checked = true;
        $('#buyerMisc').classList.add('hidden');
      }else{
        $('#formSeller').reset();
        $('#sAgentRate').value = 2;
        $('#sNotary').value = 15000;
        $('#sellerMisc').classList.add('hidden');
      }
      resetResults();
    });

    function resetResults(){
      $('#placeholder').classList.remove('hidden');
      $('#buyerResults').classList.add('hidden');
      $('#sellerResults').classList.add('hidden');
    }

    // ä¸»æŒ‰éˆ•
    $('#btnCalc').addEventListener('click', ()=>{ mode==='buyer' ? runBuyer() : runSeller(); });

    /* ==========================
       è²·æ–¹è¨ˆç®—
       ========================== */
    function calcBuyerLoan(priceWan, ratio, loanYears, interestRate, graceYears, misc){
      const priceNT = parseFloat(priceWan) * 10000;
      const loanAmount = priceNT * (parseFloat(ratio)/100);
      const downPayment = priceNT - loanAmount;

      const totalMisc = Object.values(misc).reduce((s,v)=> s + (parseFloat(v)||0), 0);
      const totalDown = downPayment + totalMisc;

      const monthlyRate = parseFloat(interestRate)/100/12;
      const totalMonths = parseInt(loanYears)*12;
      const graceMonths = parseInt(graceYears)||0;

      let monthlyPayment = 0;
      if(monthlyRate>0){
        const pow = Math.pow(1+monthlyRate, totalMonths);
        monthlyPayment = loanAmount * monthlyRate * pow / (pow - 1);
      }else{
        monthlyPayment = loanAmount / totalMonths;
      }
      const gracePayment = loanAmount * monthlyRate;
      const totalInterest = (monthlyPayment * (totalMonths - graceMonths)) + (gracePayment * graceMonths) - loanAmount;
      const totalRepayment = loanAmount + totalInterest;

      return {
        loanAmount: loanAmount/10000,
        downPayment: downPayment/10000,
        totalDownPayment: totalDown/10000,
        totalMiscFees: totalMisc/10000,
        monthlyPayment: Math.round(monthlyPayment),
        gracePayment: Math.round(gracePayment),
        totalInterest: totalInterest/10000,
        totalRepayment: totalRepayment/10000
      };
    }

    function runBuyer(){
      const priceWan = parseFloat($('#bHousePrice').value);
      if(!priceWan || priceWan<=0){ alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿å±‹ç¸½åƒ¹'); return; }

      const loanYears = $('#bLoanYears').value;
      const interest = $('#bInterest').value;
      const graceYears = $('#bGraceYears').value || 0;
      const misc = {
        serviceFee: $('#bServiceFee').value,
        notaryFee: $('#bNotaryFee').value,
        agentFee: $('#bAgentFee').value,
        contractTax: $('#bContractTax').value,
        registrationFee: $('#bRegFee').value,
        insurance: $('#bInsurance').value
      };

      const results = {
        '75': calcBuyerLoan(priceWan, '75', loanYears, interest, graceYears, misc),
        '80': calcBuyerLoan(priceWan, '80', loanYears, interest, graceYears, misc),
        '85': calcBuyerLoan(priceWan, '85', loanYears, interest, graceYears, misc),
      };

      // KPIï¼ˆä»¥ 8 æˆç‚ºä¸»ï¼‰
      $('#bHeroDown').textContent = fmt(results['80'].totalDownPayment*10000);
      $('#bHeroLoan').textContent  = fmt(results['80'].loanAmount*10000);

      // ä»¥å¡ç‰‡åˆ—å‡ºä¸‰ç¨®æˆæ•¸
      const grid = $('#bDetailGrid');
      grid.innerHTML = '';
      Object.entries(results).forEach(([ratio, r])=>{
        const div = document.createElement('div');
        div.className = 'kpi';
        div.innerHTML = `
          <div class="label"><strong>${ratio}æˆè²¸æ¬¾</strong></div>
          <div class="value" style="font-size:16px;">
            ç¸½è‡ªå‚™æ¬¾ï¼šNT$ ${fmt(r.totalDownPayment*10000)}<br>
            è²¸æ¬¾é‡‘é¡ï¼šNT$ ${fmt(r.loanAmount*10000)}<br>
            æ¯æœˆé‚„æ¬¾ï¼šNT$ ${fmt(r.monthlyPayment)}<br>
            å¯¬é™æœŸæœˆä»˜ï¼šNT$ ${fmt(r.gracePayment)}
          </div>`;
        grid.appendChild(div);
      });

      // é¡¯ç¤ºå€åˆ‡æ›
      $('#placeholder').classList.add('hidden');
      $('#sellerResults').classList.add('hidden');
      $('#buyerResults').classList.remove('hidden');
    }

    /* ==========================
       è³£æ–¹è¨ˆç®—ï¼ˆæˆ¿åœ°åˆä¸€ç¨… 2.0ï¼‰
       ========================== */
    function runSeller(){
      const saleWan = parseFloat($('#sSalePrice').value);
      const purchaseWan = parseFloat($('#sPurchasePrice').value);
      const pDate = $('#sPurchaseDate').value;
      const sDate = $('#sSaleDate').value;

      if(!saleWan || !purchaseWan || !pDate || !sDate){ alert('è«‹å¡«å…¥æ‰€æœ‰å¿…è¦è³‡è¨Š'); return; }

      const salePrice = saleWan * 10000;
      const purchasePrice = purchaseWan * 10000;
      const holdingYears = (new Date(sDate) - new Date(pDate)) / (1000*60*60*24*365);

      const isOwner = $('#sOwner').checked;
      const hasResi = $('#sResidence').checked;
      const rentedOrBiz = $('#sRented').checked;

      const improve = parseFloat($('#sImprove').value)||0;
      const lvi = parseFloat($('#sLVI').value)||0;
      const agentRate = parseFloat($('#sAgentRate').value)||0;
      const agentFee = salePrice * (agentRate/100);
      const notary = parseFloat($('#sNotary').value)||0;
      const contract = parseFloat($('#sContract').value)||0;
      const stamp = parseFloat($('#sStamp').value)||0;
      const cert = parseFloat($('#sCert').value)||0;
      const payoff = parseFloat($('#sPayoff').value)||0;
      const other = parseFloat($('#sOther').value)||0;

      const relatedFees = agentFee + notary + contract + stamp + cert + improve;
      const taxable = salePrice - purchasePrice - relatedFees - lvi;

      const qualify = isOwner && hasResi && !rentedOrBiz && holdingYears >= 6;
      let taxRate = 0, cgt = 0, exemptAmt = 0;
      if(qualify){
        if(taxable <= 4_000_000){ cgt = 0; taxRate = 0; exemptAmt = Math.max(0, taxable); }
        else{ cgt = (taxable - 4_000_000) * 0.10; taxRate = 0.10; exemptAmt = 4_000_000; }
      }else{
        if(holdingYears < 2) taxRate = 0.45;
        else if(holdingYears < 5) taxRate = 0.35;
        else if(holdingYears < 10) taxRate = 0.20;
        else taxRate = 0.15;
        cgt = Math.max(0, taxable * taxRate);
      }

      const totalFees = agentFee + notary + contract + stamp + cert + payoff + other + cgt;
      const net = salePrice - totalFees;

      // KPI
      $('#sHeroNet').textContent = fmt(net);
      $('#sYears').textContent = (holdingYears).toFixed(1);
      $('#sRate').textContent = (taxRate*100).toFixed(0) + '%';
      if(qualify){ $('#sBadge').classList.remove('hidden'); } else { $('#sBadge').classList.add('hidden'); }
      if(exemptAmt>0){ $('#sExempt').classList.remove('hidden'); $('#sExemptAmt').textContent = fmt(exemptAmt); }
      else{ $('#sExempt').classList.add('hidden'); }

      // å°å¡
      $('#sSale').textContent = 'NT$ ' + fmt(salePrice);
      $('#sTaxable').textContent = 'NT$ ' + fmt(taxable);
      $('#sCGT').textContent = 'NT$ ' + fmt(cgt);
      $('#sAgent').textContent = 'NT$ ' + fmt(agentFee);

      // é¡¯ç¤ºå€åˆ‡æ›
      $('#placeholder').classList.add('hidden');
      $('#buyerResults').classList.add('hidden');
      $('#sellerResults').classList.remove('hidden');
    }
  </script>
</body>
</html>
